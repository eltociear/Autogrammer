import {
  describe,
  test,
  expect,
} from 'vitest';
// import SQL2GBNF from 'sql2gbnf';
import { SQL2GBNF } from '../../src/sql2gbnf.js';
import GBNF, {
  WHITESPACE_KEY,
  // InputParseError,
  GLOBAL_CONSTANTS as GBNF_GLOBAL_CONSTANTS,
} from 'gbnf';
import { GLOBAL_CONSTANTS } from '../../src/constants/constants.js';
import {
  BOOLEAN_KEY,
  COMMA_KEY,
  NULL_KEY,
  NUMBER_KEY,
  DOUBLE_QUOTE_KEY,
  SEMI_KEY,
  STRING_KEY,
  SINGLE_QUOTE_KEY,
  LEFT_PAREN_KEY,
  RIGHT_PAREN_KEY,
} from '../../src/constants/grammar-keys.js';
import {
  AGGREGATOR_FUNCTION_KEY,
  AND_KEY,
  AND_MORE,
  ANY_OPERATOR_KEY,
  ANY_WHERE_CLAUSE,
  AS_KEY,
  BETWEEN_KEY,
  BETWEEN_WHERE_CLAUSE,
  DIRECTION_KEY,
  DISTINCT_KEY,
  FROM_KEY,
  IN_KEY,
  IN_WHERE_CLAUSE,
  IS_KEY,
  LIKE_KEY,
  LIMIT_CLAUSE,
  LIMIT_KEY,
  NOT_KEY,
  NUMERIC_OPERATORS_KEY,
  NUMERIC_WHERE_CLAUSE,
  OPTIONAL_WHITESPACE_KEY,
  ORDER_CLAUSE,
  ORDER_KEY,
  OR_KEY,
  OR_MORE,
  SELECT_COLUMNS_KEY,
  SELECT_KEY,
  SELECT_LIST_KEY,
  SELECT_QUERY_KEY,
  STRING_WILDCARD_WITH_DOUBLE_QUOTES_KEY,
  STRING_WILDCARD_WITH_SINGLE_QUOTES_KEY,
  STRING_WITH_DOUBLE_QUOTES_KEY,
  STRING_WITH_QUOTES_KEY,
  STRING_WITH_SINGLE_QUOTES_KEY,
  STR_OPERATORS_KEY,
  TABLE_KEY,
  VALUE_KEY,
  WHERE_CLAUSE,
  WHERE_INNER,
  WHERE_KEY,
  WILDCARD_WHERE_CLAUSE,
} from '../../src/parse.js';

describe('no schema', () => {
  const NO_SCHEMA_GRAMMAR = [
    `root ::= sql2gbnf`,
    `sql2gbnf ::= selectquery`,
    `${SELECT_KEY} ::= "select" | "SELECT"`,
    `${FROM_KEY} ::= "from" | "FROM"`,
    `${WHERE_KEY} ::= "where" | "WHERE"`,
    `${ORDER_KEY} ::= "order by" | "ORDER BY"`,
    `${LIMIT_KEY} ::= "limit" | "LIMIT"`,
    `${AND_KEY} ::= "and" | "AND"`,
    `${AS_KEY} ::= "as" | "AS"`,
    `${OR_KEY} ::= "or" | "OR"`,
    `${NOT_KEY} ::= "not" | "NOT"`,
    `${IS_KEY} ::= "is" | "IS"`,
    `${IN_KEY} ::= "in" | "IN"`,
    `${LIKE_KEY} ::= "like" | "LIKE"`,
    `${BETWEEN_KEY} ::= "between" | "BETWEEN"`,
    [
      ANY_OPERATOR_KEY,
      "::=",
      '"="',
      "|",
      IS_KEY,
    ].join(" "),
    [
      NUMERIC_OPERATORS_KEY,
      "::=",
      '">"',
      '|',
      '"<"',
      "|",
      '">="',
      "|",
      '"<="',
    ].join(" "),
    [
      STR_OPERATORS_KEY,
      "::=",
      LIKE_KEY,
    ].join(" "),
    `${AGGREGATOR_FUNCTION_KEY} ::= "min" | "MIN" | "max" | "MAX" | "avg" | "AVG" | "sum" | "SUM" | "count" | "COUNT"`,
    `${SELECT_LIST_KEY} ::= (${STRING_KEY} | (agg ${LEFT_PAREN_KEY} ${STRING_KEY} ${RIGHT_PAREN_KEY})) (${WHITESPACE_KEY} as ${WHITESPACE_KEY} ${STRING_KEY})?`,
    `${SELECT_COLUMNS_KEY} ::= ${SELECT_LIST_KEY} (${COMMA_KEY} ${OPTIONAL_WHITESPACE_KEY} ${SELECT_LIST_KEY})*`,
    `${TABLE_KEY} ::= ${STRING_KEY}`,
    `${STRING_WITH_SINGLE_QUOTES_KEY} ::= ${SINGLE_QUOTE_KEY} ${STRING_KEY} ${SINGLE_QUOTE_KEY}`,
    `${STRING_WITH_DOUBLE_QUOTES_KEY} ::= ${DOUBLE_QUOTE_KEY} ${STRING_KEY} ${DOUBLE_QUOTE_KEY}`,
    `${STRING_WITH_QUOTES_KEY} ::= (${STRING_WITH_SINGLE_QUOTES_KEY} | ${STRING_WITH_DOUBLE_QUOTES_KEY})`,
    `${STRING_WILDCARD_WITH_SINGLE_QUOTES_KEY} ::= ${SINGLE_QUOTE_KEY} ${STRING_KEY} "%" ${SINGLE_QUOTE_KEY}`,
    `${STRING_WILDCARD_WITH_DOUBLE_QUOTES_KEY} ::= ${DOUBLE_QUOTE_KEY} ${STRING_KEY} "%" ${DOUBLE_QUOTE_KEY}`,
    [
      OPTIONAL_WHITESPACE_KEY,
      '::=',
      `(${WHITESPACE_KEY})?`,
    ].join(' '),
    [
      VALUE_KEY,
      '::=',
      `(${NUMBER_KEY} | ${NULL_KEY} | ${BOOLEAN_KEY} | ${STRING_WITH_QUOTES_KEY})`,
    ].join(' '),
    [
      ANY_WHERE_CLAUSE,
      '::=',
      ANY_OPERATOR_KEY,
      OPTIONAL_WHITESPACE_KEY,
      VALUE_KEY,
    ].join(' '),
    [
      NUMERIC_WHERE_CLAUSE,
      '::=',
      NUMERIC_OPERATORS_KEY,
      OPTIONAL_WHITESPACE_KEY,
      NUMBER_KEY,
    ].join(' '),
    [
      WILDCARD_WHERE_CLAUSE,
      '::=',
      STR_OPERATORS_KEY,
      OPTIONAL_WHITESPACE_KEY,
      `(${STRING_WILDCARD_WITH_SINGLE_QUOTES_KEY} | ${STRING_WILDCARD_WITH_DOUBLE_QUOTES_KEY})`,
    ].join(' '),
    [
      IN_WHERE_CLAUSE,
      '::=',
      IN_KEY,
      WHITESPACE_KEY,
      LEFT_PAREN_KEY,
      STRING_WITH_QUOTES_KEY,
      `(${COMMA_KEY} ${OPTIONAL_WHITESPACE_KEY} ${STRING_WITH_QUOTES_KEY})*`,
      RIGHT_PAREN_KEY,
    ].join(' '),
    [
      BETWEEN_WHERE_CLAUSE,
      '::=',
      BETWEEN_KEY,
      WHITESPACE_KEY,
      NUMBER_KEY,
      WHITESPACE_KEY,
      AND_KEY,
      WHITESPACE_KEY,
      NUMBER_KEY,
    ].join(' '),
    [
      WHERE_INNER,
      '::=',
      WHITESPACE_KEY,
      STRING_KEY,
      OPTIONAL_WHITESPACE_KEY,
      `(${[
        ANY_WHERE_CLAUSE,
        NUMERIC_WHERE_CLAUSE,
        WILDCARD_WHERE_CLAUSE,
        IN_WHERE_CLAUSE,
        BETWEEN_WHERE_CLAUSE,
      ].join(' | ')})`,
    ].join(' '),
    `${AND_MORE} ::= ${WHITESPACE_KEY} ${AND_KEY} ${WHERE_INNER}`,
    `${OR_MORE} ::= ${WHITESPACE_KEY} ${OR_KEY} ${WHERE_INNER}`,
    `${WHERE_CLAUSE} ::= ${WHITESPACE_KEY} ${WHERE_KEY} (${NOT_KEY})? ${WHERE_INNER} (${AND_MORE} | ${OR_MORE})*`,
    `${DIRECTION_KEY} ::= "asc" | "ASC" | "desc" | "DESC"`,
    [
      ORDER_CLAUSE,
      '::=',
      WHITESPACE_KEY,
      ORDER_KEY,
      WHITESPACE_KEY,
      STRING_KEY,
      `(${WHITESPACE_KEY} ${DIRECTION_KEY})?`,
    ].join(' '),
    [
      LIMIT_CLAUSE,
      '::=',
      WHITESPACE_KEY,
      LIMIT_KEY,
      `(${WHITESPACE_KEY} ${NUMBER_KEY} ${COMMA_KEY})?`,
      WHITESPACE_KEY,
      NUMBER_KEY,
    ].join(' '),
    `${DISTINCT_KEY} ::= "distinct" | "DISTINCT"`,
    [
      SELECT_QUERY_KEY,
      '::=',
      SELECT_KEY,
      `(${WHITESPACE_KEY} ${DISTINCT_KEY})?`,
      WHITESPACE_KEY,
      `(${SELECT_COLUMNS_KEY} | "*")`,
      WHITESPACE_KEY,
      FROM_KEY,
      WHITESPACE_KEY,
      TABLE_KEY,
      `(${WHERE_CLAUSE})?`,
      `(${ORDER_CLAUSE})?`,
      `(${LIMIT_CLAUSE})?`,
      `(${SEMI_KEY})?`,
    ].join(' '),
  ];

  test.each([
    'selec',
    'SELEC',
    'select *',
    'select fo',
    'select foo,bar,froo',
    'select * from',
    'select * FROM',
    'SELECT * FROM',
    'select fromm from',
    'select col from table',
    'select col as foo from table',
    'select fooy as foo,bary as bar from table',
    'SELECT col FROM table',
    'SELECT col FROM table;',
    'SELECT col FROM table WHERE',
    'SELECT col FROM table where',
    'SELECT foo,bar FROM table;',
    'SELECT foo,bar,baz FROM table;',
    'SELECT foo, bar, baz FROM table;',
    'SELECT MIN(col) FROM table',
    'SELECT min(col) FROM table',
    'SELECT MAX(col) FROM table',
    'SELECT max(col) FROM table',
    'SELECT COUNT(col) FROM table',
    'SELECT count(col) FROM table',
    'SELECT SUM(col) FROM table',
    'SELECT sum(col) FROM table',
    'SELECT AVG(col) FROM table',
    'SELECT avg(col) FROM table',
    'SELECT col FROM table where col',
    'SELECT col FROM table WHERE col',
    'SELECT col FROM table WHERE col=',
    'SELECT col FROM table WHERE col =',
    'SELECT col FROM table WHERE col =1',
    'SELECT col FROM table WHERE col =1;',
    'SELECT col FROM table WHERE col = 1',
    'SELECT col FROM table WHERE col = 1;',
    'SELECT col FROM table WHERE col = true;',
    'SELECT col FROM table WHERE col = TRUE;',
    'SELECT col FROM table WHERE col = false;',
    'SELECT col FROM table WHERE col = FALSE;',
    'SELECT col FROM table WHERE col = null;',
    'SELECT col FROM table WHERE col = NULL;',
    'SELECT col FROM table WHERE col IS null;',
    'SELECT col FROM table WHERE col is NULL;',
    'SELECT col FROM table WHERE col = \'foo\'',
    'SELECT col FROM table WHERE col = "foo"',
    'SELECT col FROM table WHERE col = \'foo\';',
    'SELECT col FROM table WHERE col = "foo";',
    'SELECT col FROM table WHERE col = "foo" and bar > 1',
    'SELECT col FROM table WHERE col = "foo" AND bar > 1',
    'SELECT col FROM table WHERE col = "foo" or bar > 1',
    'SELECT col FROM table WHERE col = "foo" OR bar > 1',
    'SELECT col FROM table WHERE col IN ("foo")',
    'SELECT col FROM table WHERE col IN (\'foo\')',
    'SELECT col FROM table WHERE col IN ("foo","bar")',
    'SELECT col FROM table WHERE col in ("foo","bar")',
    'SELECT col FROM table WHERE col in ("foo","bar",\'baz\')',
    'SELECT col FROM table WHERE col in ("foo", "bar")',
    'SELECT col FROM table WHERE col BETWEEN 2 AND 10',
    'SELECT col FROM table WHERE col between 2 and 10',
    'SELECT col FROM table order by',
    'SELECT col FROM table order by col',
    'SELECT col FROM table order by col;',
    'SELECT col FROM table order by col desc',
    'SELECT col FROM table order by col DESC',
    'SELECT col FROM table order by col ASC',
    'SELECT col FROM table order by col asc',
    'SELECT col FROM table limit',
    'SELECT col FROM table limit 5',
    'SELECT col FROM table limit 5;',
    'SELECT col FROM table limit 2, ',
    'SELECT col FROM table limit 2, 5',
    'SELECT col FROM table limit 2, 5;',
    'SELECT distinct col FROM table;',
    'SELECT DISTINCT col FROM table;',
    'SELECT foo,bar,baz FROM table where foo = 1 and bar = "bar" AND baz = \'baz\' order by bar desc limit 2, 5;',
  ])('it parses schema to grammar with input "%s"', (initial) => {
    const grammar = SQL2GBNF();
    expect(grammar).toEqual([
      ...NO_SCHEMA_GRAMMAR,
      ...GBNF_GLOBAL_CONSTANTS,
      ...GLOBAL_CONSTANTS
    ].join('\n'));
    let parser = GBNF(grammar);
    parser = parser.add(initial);
    expect(parser.size).toBeGreaterThan(0);
  });

  // test.only.each([
  //   ['select select', 0],
  //   ['select SELECT', 0],
  //   ['select from ', 0],
  // ])('it rejects %s for a non-schema', (_initial, errorPos) => {
  //   const grammar = SQL2GBNF();
  //   let parser = GBNF(grammar);
  //   const initial = _initial.split('\\n').join('\n');
  //   expect(() => parser.add(initial)).toThrowError(new InputParseError(initial, errorPos));
  // });
});
